### Cross-Origin Resource Sharing (CORS)
***
Cross-Origin Resource Sharing (CORS) — механизм
политики безопасности браузера, использующий
дополнительные HTTP-заголовки, чтобы дать возможность агенту
пользователя получать разрешения на доступ к выбранным ресурсам
с сервера на источнике (домене), отличном от того, что сайт использует
в данный момент. Говорят, что агент пользователя делает запрос с другого
источника (cross-origin HTTP request), если источник текущего документа
отличается от запрашиваемого ресурса доменом, протоколом или портом.

Пример cross-origin запроса: HTML страница, обслуживаемая сервером с
http://domain-a.com, запрашивает `img src` по адресу
http://domain-b.com/image.jpg. Сегодня многие страницы загружают
ресурсы вроде CSS-стилей, изображений и скриптов с разных доменов,
соответствующих разным сетям доставки контента
(Content delivery networks, CDNs).

В целях безопасности браузеры ограничивают cross-origin запросы,
инициируемые скриптами. Например, XMLHttpRequest и Fetch API следуют
политике одного источника (same-origin policy). Это значит, что
web-приложения, использующие такие API, могут запрашивать HTTP-ресурсы
только с того домена, с которого были загружены, пока не будут
использованы CORS-заголовки.

### Непростые запросы и предварительные запросы (preflights)
***
Простые запросы — это:
> Запросы: GET,POST
> Тип содержимого следующего:
> text/plain
> application/x-www-form-urlencoded
> multipart/form-data

Любой заголовок, который не разрешен для простых запросов,
требует предварительного запроса (preflight request).

Этот механизм позволяет веб-серверам решать, хотят ли они разрешить
фактический запрос. Браузер устанавливает заголовки
Access-Control-Request-Headers и Access-Control-Request-Method,
чтобы сообщить серверу, какой запрос ожидать, и сервер должен ответить
соответствующими заголовками.

Но наш сервер еще не отвечает с этими заголовками,
поэтому нам нужно добавить их:
```
app.options('*', (req, res) => {
  res.set('Access-Control-Allow-Origin', '*');
  res.set("Access-Control-Allow-Headers", "Content-Type");
  res.send('ok');
});
app.get('/public', function(req, res) {
  res.set('Access-Control-Allow-Origin', '*')
  res.set('Access-Control-Allow-Methods', 'GET, OPTIONS')
  res.set('Access-Control-Allow-Headers', 'Content-Type')
  res.send(JSON.stringify({
    message: 'This is public info'
  }))
});
app.get('/private', function(req, res) {
  res.set('Access-Control-Allow-Origin', 'http://127.0.0.1:8000')
  res.set('Access-Control-Allow-Credentials', 'true')
  if(req.session.loggedIn === true) {
    res.send('THIS IS THE SECRET')
  } else {
    res.send('Please login first')
  }
});
```

### Пару слов о CSRF
***
Обратите внимание, что существует класс атак, называемый подделкой
межсайтовых запросов (Cross Site Request Forgery — csrf ),
от которых не защищает Same-Origin Policy.

При CSRF-атаке злоумышленник отправляет запрос сторонней странице в
фоновом режиме, например, отправляя POST запрос на веб-сайт
вашего банка. Если у вас в этот момент есть действительный сеанс с
вашим банком, любой веб-сайт может сгенерировать запрос в фоновом
режиме, который будет выполнен, если ваш банк не использует контрмеры
против CSRF.

Так же обратите внимание, что, несмотря на то, что действует
Same-Origin Policy, наш пример запроса с сайта secondparty.com на
сайте 127.0.0.1:3000 будет успешно выполнен — мы просто не соможем
получить доступ к результатам. Но для CSRF нам не нужен результат…

### Выводы
***
- Браузер использует Same-origin policy, чтобы не обрабатывать AJAX
ответы от веб-сайтов расположенных на адресах отличных от адреса с
которого была загружена веб страница.
- Same-origin policy не запрещает генерировать запросы к другим сайтам,
но запрещает обрабатывать от них ответ.
- CORS (Cross-Origin Resource Sharing) механизм, который использует
дополнительные заголовки HTTP, чтобы дать браузерам указание
предоставить веб-приложению, работающему в одном источнике, доступ к
ответу на запрос к ресурсам из другого источника.
- CORS вместе с credentials (с данными аутентификации) требует
осторожности.
- CORS это браузерная политика. Другие приложения не затрагиваются
этим понятием.
